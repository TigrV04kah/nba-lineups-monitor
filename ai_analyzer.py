"""
AI Analyzer - –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–∞–≤–∞ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä–æ–∫–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Å–∞–π—Ç–æ–≤
"""

import os
import re
from openai import OpenAI
from dotenv import load_dotenv

# –ò–º–ø–æ—Ä—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
try:
    from news_scraper import get_relevant_news_for_analysis
except ImportError:
    def get_relevant_news_for_analysis(*args, **kwargs):
        return {'player_news': [], 'team_news': [], 'opponent_news': [], 'has_relevant_news': False}

# –ò–º–ø–æ—Ä—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±—É–∫–º–µ–∫–µ—Ä—Å–∫–∏–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏
try:
    from betting_odds import (
        get_cached_odds, find_player_odds, compare_ai_with_odds,
        odds_to_probability
    )
    BETTING_ODDS_AVAILABLE = True
except ImportError:
    BETTING_ODDS_AVAILABLE = False

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
client = None


def parse_ai_prediction_ranges(ai_response: str) -> dict:
    """
    –ü–∞—Ä—Å–∏–Ω–≥ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI.

    –ò—â–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∏–¥–∞:
    - –û—á–∫–∏: 18-24
    - –ü–æ–¥–±–æ—Ä—ã: 5-8
    - –ü–µ—Ä–µ–¥–∞—á–∏: 3-6

    Returns:
        dict —Å –∫–ª—é—á–∞–º–∏ 'points', 'rebounds', 'assists' –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (min, max)
    """
    result = {}

    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
    # –£—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ ** –≤–æ–∫—Ä—É–≥ —Å–ª–æ–≤ (markdown bold)
    patterns = {
        'points': [
            r'\*{0,2}[–û–æ]—á–∫–∏\*{0,2}[:\s]+(\d+)\s*[-‚Äì]\s*(\d+)',
            r'\*{0,2}[Pp]oints\*{0,2}[:\s]+(\d+)\s*[-‚Äì]\s*(\d+)',
            r'(\d+)\s*[-‚Äì]\s*(\d+)\s*–æ—á–∫',
            r'(\d+)\s*[-‚Äì]\s*(\d+)\s*pts',
        ],
        'rebounds': [
            r'\*{0,2}[–ü–ø]–æ–¥–±–æ—Ä[—ã–∞]\*{0,2}[:\s]+(\d+)\s*[-‚Äì]\s*(\d+)',
            r'\*{0,2}[Rr]ebounds\*{0,2}[:\s]+(\d+)\s*[-‚Äì]\s*(\d+)',
            r'(\d+)\s*[-‚Äì]\s*(\d+)\s*–ø–æ–¥–±–æ—Ä',
            r'(\d+)\s*[-‚Äì]\s*(\d+)\s*reb',
        ],
        'assists': [
            r'\*{0,2}[–ü–ø]–µ—Ä–µ–¥–∞—á[–∏–∞]\*{0,2}[:\s]+(\d+)\s*[-‚Äì]\s*(\d+)',
            r'\*{0,2}[Aa]ssists\*{0,2}[:\s]+(\d+)\s*[-‚Äì]\s*(\d+)',
            r'(\d+)\s*[-‚Äì]\s*(\d+)\s*–ø–µ—Ä–µ–¥–∞—á',
            r'(\d+)\s*[-‚Äì]\s*(\d+)\s*ast',
        ],
    }

    for stat_type, stat_patterns in patterns.items():
        for pattern in stat_patterns:
            match = re.search(pattern, ai_response, re.IGNORECASE)
            if match:
                try:
                    min_val = float(match.group(1))
                    max_val = float(match.group(2))
                    result[stat_type] = (min_val, max_val)
                    break
                except (ValueError, IndexError):
                    continue

    return result


def compare_with_bookmaker_odds(player_name: str, ai_predictions: dict) -> str:
    """
    –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ AI —Å –±—É–∫–º–µ–∫–µ—Ä—Å–∫–∏–º–∏ –ª–∏–Ω–∏—è–º–∏.

    Args:
        player_name: –ò–º—è –∏–≥—Ä–æ–∫–∞
        ai_predictions: –°–ª–æ–≤–∞—Ä—å —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ AI {stat_type: (min, max)}

    Returns:
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    """
    if not BETTING_ODDS_AVAILABLE:
        return ""

    if not ai_predictions:
        return ""

    try:
        odds_data = get_cached_odds()
        if not odds_data:
            return ""
    except Exception as e:
        return f"\n\n‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—É–∫–º–µ–∫–µ—Ä—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö: {e}"

    # –ò—â–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–∞
    all_player_odds = find_player_odds(player_name, odds_data)

    if not all_player_odds:
        return ""

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≤—ã–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ª–∏–Ω–∏–∏
    odds_by_type = {}
    for odds in all_player_odds:
        stat_type = odds.stat_type
        if stat_type not in odds_by_type:
            odds_by_type[stat_type] = []
        odds_by_type[stat_type].append(odds)

    comparisons = []
    stat_names = {
        'points': '–û—á–∫–∏',
        'rebounds': '–ü–æ–¥–±–æ—Ä—ã',
        'assists': '–ü–µ—Ä–µ–¥–∞—á–∏',
        'pra': '–û+–ü+–ü'
    }

    for stat_type, ai_range in ai_predictions.items():
        if stat_type not in odds_by_type:
            continue

        # –ë–µ—Ä—ë–º –æ—Å–Ω–æ–≤–Ω—É—é –ª–∏–Ω–∏—é (–±–ª–∏–∂–∞–π—à—É—é –∫ —Å—Ä–µ–¥–Ω–µ–º—É –ø—Ä–æ–≥–Ω–æ–∑—É AI)
        ai_mid = (ai_range[0] + ai_range[1]) / 2

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ª–∏–Ω–∏–∏ –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ –ø—Ä–æ–≥–Ω–æ–∑—É AI
        sorted_odds = sorted(
            odds_by_type[stat_type],
            key=lambda x: abs(x.total_line - ai_mid)
        )

        # –ë–µ—Ä—ë–º –±–ª–∏–∂–∞–π—à—É—é –ª–∏–Ω–∏—é
        if sorted_odds:
            main_odds = sorted_odds[0]

            comparison = compare_ai_with_odds(
                ai_prediction_range=ai_range,
                total_line=main_odds.total_line,
                over_odds=main_odds.over_odds,
                under_odds=main_odds.under_odds
            )
            comparison['stat_type'] = stat_type
            comparison['stat_name'] = stat_names.get(stat_type, stat_type)
            comparisons.append(comparison)

    if not comparisons:
        return ""

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
    lines = ["\n\nüìä –°–†–ê–í–ù–ï–ù–ò–ï –° –ë–£–ö–ú–ï–ö–ï–†–°–ö–ò–ú–ò –õ–ò–ù–ò–Ø–ú–ò:"]

    for comp in comparisons:
        stat_emoji = {'points': 'üèÄ', 'rebounds': 'üìä', 'assists': 'üéØ', 'pra': 'üìà'}.get(
            comp['stat_type'], '‚Ä¢'
        )

        line = comp['total_line']
        ai_pred = comp['ai_prediction']
        over = comp['over_odds']
        under = comp['under_odds']
        diff = comp['diff_from_line']

        over_prob = odds_to_probability(over) * 100 if over > 1 else 0
        under_prob = odds_to_probability(under) * 100 if under > 1 else 0

        direction_ru = "–±–æ–ª—å—à–µ" if comp['ai_direction'] == 'over' else "–º–µ–Ω—å—à–µ"
        bookie_favors = comp['bookie_favors']
        bookie_ru = "–±–æ–ª—å—à–µ" if bookie_favors == 'over' else ("–º–µ–Ω—å—à–µ" if bookie_favors == 'under' else "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ")

        lines.append(f"\n{stat_emoji} {comp['stat_name']} (–ª–∏–Ω–∏—è {line}):")
        lines.append(f"   –ü—Ä–æ–≥–Ω–æ–∑ AI: {ai_pred} ‚Üí —Å—Ç–∞–≤–∏—Ç –Ω–∞ {direction_ru}")
        lines.append(f"   –ë—É–∫–º–µ–∫–µ—Ä: –ë{line}={over} ({over_prob:.0f}%), –ú{line}={under} ({under_prob:.0f}%)")

        if bookie_favors == "neutral":
            lines.append(f"   ‚ÑπÔ∏è –ù–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±—É–∫–º–µ–∫–µ—Ä–∞")
        elif comp['ai_agrees_with_bookie']:
            lines.append(f"   ‚úÖ AI —Å–æ–≥–ª–∞—Å–µ–Ω —Å –±—É–∫–º–µ–∫–µ—Ä–æ–º ({bookie_ru})")
        else:
            lines.append(f"   ‚ö†Ô∏è AI –ù–ï —Å–æ–≥–ª–∞—Å–µ–Ω —Å –±—É–∫–º–µ–∫–µ—Ä–æ–º (–±—É–∫ —Å—Ç–∞–≤–∏—Ç –Ω–∞ {bookie_ru})")
            lines.append(f"   üí° –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è value —Å—Ç–∞–≤–∫–∞ –Ω–∞ {direction_ru}!")

    return "\n".join(lines)


def init_openai():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞."""
    global client
    api_key = os.getenv('OPENAI_API_KEY')

    if not api_key:
        print("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        return False

    try:
        client = OpenAI(api_key=api_key)
        return True
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI: {e}")
        return False


def analyze_lineup_changes(team_abbrev: str, changes: dict, team_stats: dict) -> str:
    """
    –ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–∞–≤–∞ –Ω–∞ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤.

    Args:
        team_abbrev: –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
        changes: –°–ª–æ–≤–∞—Ä—å —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ {'new_players': [...], 'removed_players': [...]}
        team_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã

    Returns:
        –¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç AI
    """
    if not client:
        if not init_openai():
            return "AI –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API –∫–ª—é—á"

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI
    new_players = changes.get('new_players', [])
    removed_players = changes.get('removed_players', [])

    if not new_players and not removed_players:
        return "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–æ—Å—Ç–∞–≤–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"

    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–æ–≤
    stats_context = ""
    if team_stats and 'games' in team_stats:
        stats_context = "\n\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∏–≥—Ä –∫–æ–º–∞–Ω–¥—ã:\n"
        for game in team_stats['games'][:5]:
            stats_context += f"\n{game['matchup']} ({game['result']}):\n"
            for starter in game['starters']:
                stats_context += f"  - {starter['name']} ({starter['position']}): {starter['pts']}pts, {starter['reb']}reb, {starter['ast']}ast\n"

    # –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    prompt = f"""–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ NBA –∞–Ω–∞–ª–∏—Ç–∏–∫–µ. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º —Å–æ—Å—Ç–∞–≤–µ –∫–æ–º–∞–Ω–¥—ã {team_abbrev} –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –∏—Ö –ü–û–°–õ–ï–î–ù–ï–ô –°–´–ì–†–ê–ù–ù–û–ô –∏–≥—Ä–æ–π.

–ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –°–û–°–¢–ê–í–ï –ù–ê –°–ï–ì–û–î–ù–Ø:
- –ù–ï –ë–£–î–£–¢ –≤ —Å—Ç–∞—Ä—Ç–µ —Å–µ–≥–æ–¥–Ω—è (–±—ã–ª–∏ –≤ –ø—Ä–æ—à–ª–æ–π –∏–≥—Ä–µ): {', '.join(removed_players) if removed_players else '–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π'}
- –í–ï–†–ù–£–õ–ò–°–¨/–ù–û–í–´–ï –≤ —Å—Ç–∞—Ä—Ç–µ —Å–µ–≥–æ–¥–Ω—è (–Ω–µ –∏–≥—Ä–∞–ª–∏ –≤ –ø—Ä–æ—à–ª–æ–π –∏–≥—Ä–µ): {', '.join(new_players) if new_players else '–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π'}
{stats_context}

–ó–ê–î–ê–ß–ê:
1. –ï–°–õ–ò –µ—Å—Ç—å –≤—ã–±—ã–≤—à–∏–µ –∏–≥—Ä–æ–∫–∏ - –æ–±—ä—è—Å–Ω–∏ –∏—Ö —Ä–æ–ª—å –∏ –∫–∞–∫ –∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É
2. –ï–°–õ–ò –µ—Å—Ç—å –≤–µ—Ä–Ω—É–≤—à–∏–µ—Å—è/–Ω–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ - –æ–±—ä—è—Å–Ω–∏ –∫–∞–∫ –∏—Ö –ü–†–ò–°–£–¢–°–¢–í–ò–ï –∏–∑–º–µ–Ω–∏—Ç –∏–≥—Ä—É:
   - –ö–∞–∫ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è –≤–ª–∞–¥–µ–Ω–∏—è –∏ –±—Ä–æ—Å–∫–∏?
   - –£ –∫–æ–≥–æ –º–æ–∂–µ—Ç –°–ù–ò–ó–ò–¢–¨–°–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑-–∑–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤?
   - –ö–∞–∫–∏–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–∞—Å—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤?
3. –ï–°–õ–ò –∏–∑–º–µ–Ω–µ–Ω–∏–π –ù–ï–¢ - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ "–°–æ—Å—Ç–∞–≤ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏–≥—Ä–æ–π"
4. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ë–û–¢–ê–ô –¢–û–õ–¨–ö–û –° –§–ê–ö–¢–ê–ú–ò:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û —Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤—ã—à–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –°–û–°–¢–ê–í–ï"
- –ï–°–õ–ò —Å–ø–∏—Å–æ–∫ –≤—ã–±—ã–≤—à–∏—Ö –ø—É—Å—Ç–æ–π ‚Üí –ù–ï –ü–ò–®–ò –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤—ã–±—ã–≤—à–∏—Ö –∏–ª–∏ —Ç—Ä–∞–≤–º–∞—Ö
- –ï–°–õ–ò —Å–ø–∏—Å–æ–∫ –≤–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è –ø—É—Å—Ç–æ–π ‚Üí –ù–ï –ü–ò–®–ò –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è—Ö
- –ï–°–õ–ò –æ–±–∞ —Å–ø–∏—Å–∫–∞ –ø—É—Å—Ç—ã ‚Üí –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ "–ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–æ—Å—Ç–∞–≤–µ –Ω–µ—Ç"
- –ù–ï –¥–µ–ª–∞–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π —Ç–∏–ø–∞ "–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤—ã–±—É–¥–µ—Ç –≤ –±—É–¥—É—â–µ–º"
- –†–∞–±–æ—Ç–∞–π –¢–û–õ–¨–ö–û —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –≤—ã—à–µ

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫—Ä–∞—Ç–∫–∏–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º (–º–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤)."""

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",  # –ë—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è –º–æ–¥–µ–ª—å
            messages=[
                {"role": "system", "content": "–¢—ã NBA –∞–Ω–∞–ª–∏—Ç–∏–∫. –î–∞—ë—à—å –∫—Ä–∞—Ç–∫–∏–µ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–ï –¥–µ–ª–∞–π –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏–ª–∏ —Ç—Ä–∞–≤–º–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã —è–≤–Ω–æ –≤ –ø—Ä–æ–º–ø—Ç–µ."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=500,
            temperature=0.7
        )

        return response.choices[0].message.content

    except Exception as e:
        return f"–û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: {e}"


def analyze_game_matchup(away_team: dict, home_team: dict, away_stats: dict, home_stats: dict) -> str:
    """
    –ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞–ø–∞ –¥–≤—É—Ö –∫–æ–º–∞–Ω–¥.

    Args:
        away_team: –î–∞–Ω–Ω—ã–µ –≥–æ—Å—Ç–µ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
        home_team: –î–∞–Ω–Ω—ã–µ –¥–æ–º–∞—à–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã
        away_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ—Å—Ç–µ–π
        home_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö–æ–∑—è–µ–≤

    Returns:
        –¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –º–∞—Ç—á–∞–ø–∞
    """
    if not client:
        if not init_openai():
            return "AI –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API –∫–ª—é—á"

    away_abbrev = away_team.get('abbrev', '???')
    home_abbrev = home_team.get('abbrev', '???')

    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Å–æ—Å—Ç–∞–≤—ã
    away_starters = []
    for player in away_team.get('lineup', [])[:5]:
        if player.get('position') in ['PG', 'SG', 'SF', 'PF', 'C']:
            away_starters.append(f"{player.get('name')} ({player.get('position')})")

    home_starters = []
    for player in home_team.get('lineup', [])[:5]:
        if player.get('position') in ['PG', 'SG', 'SF', 'PF', 'C']:
            home_starters.append(f"{player.get('name')} ({player.get('position')})")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    def format_team_stats(stats):
        if not stats or 'games' not in stats:
            return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        result = ""
        for game in stats['games'][:2]:
            result += f"\n  {game['matchup']} ({game['result']})"
        return result

    prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–π –º–∞—Ç—á NBA –Ω–∞ –æ—Å–Ω–æ–≤–µ –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

{away_abbrev} @ {home_abbrev}

–ì–û–°–¢–ò ({away_abbrev}):
–°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—è—Ç—ë—Ä–∫–∞: {', '.join(away_starters) if away_starters else '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}
–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã: {format_team_stats(away_stats)}

–•–û–ó–Ø–ï–í–ê ({home_abbrev}):
–°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—è—Ç—ë—Ä–∫–∞: {', '.join(home_starters) if home_starters else '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}
–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã: {format_team_stats(home_stats)}

–ó–ê–î–ê–ß–ê:
1. –ö–ª—é—á–µ–≤—ã–µ –º–∞—Ç—á–∞–ø—ã (–∫–∞–∫–∏–µ –∏–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –ø—Ä–æ—Ç–∏–≤–æ—Å—Ç–æ—è—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É)
2. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–∞–≤–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
3. –ö—Ç–æ –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–¥–∞—é—â—É—é—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø–æ—á–µ–º—É

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ë–û–¢–ê–ô –¢–û–õ–¨–ö–û –° –§–ê–ö–¢–ê–ú–ò:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø—è—Ç—ë—Ä–æ–∫, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤—ã—à–µ
- –ë–∞–∑–∏—Ä—É–π –≤—ã–≤–æ–¥—ã –¢–û–õ–¨–ö–û –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–≥—Ä, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –¥–∞–Ω–Ω—ã—Ö
- –ï–°–õ–ò —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—è—Ç—ë—Ä–∫–∞ "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞" ‚Üí —É–∫–∞–∂–∏ —ç—Ç–æ, –ù–ï –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π —Å–æ—Å—Ç–∞–≤
- –ù–ï –¥–µ–ª–∞–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ç—Ä–∞–≤–º–∞—Ö –∏–ª–∏ –∑–∞–º–µ–Ω–∞—Ö
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —É–∫–∞–∑–∞–Ω—ã –≤ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö —Å–æ—Å—Ç–∞–≤–∞—Ö –≤—ã—à–µ
- –†–∞–±–æ—Ç–∞–π –¢–û–õ–¨–ö–û —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –≤ —ç—Ç–æ–º –ø—Ä–æ–º–ø—Ç–µ

–û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫—Ä–∞—Ç–∫–æ (150 —Å–ª–æ–≤ –º–∞–∫—Å–∏–º—É–º)."""

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "–¢—ã NBA –∞–Ω–∞–ª–∏—Ç–∏–∫. –î–∞—ë—à—å –∫—Ä–∞—Ç–∫–∏–µ –ø—Ä–µ–≤—å—é –º–∞—Ç—á–µ–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–∞–≤–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ù–ï –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–π —Å–æ—Å—Ç–∞–≤—ã –∏–ª–∏ —Ç—Ä–∞–≤–º—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã —è–≤–Ω–æ."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=400,
            temperature=0.7
        )

        return response.choices[0].message.content

    except Exception as e:
        return f"–û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: {e}"


def analyze_player_projection(
    player_name: str,
    player_position: str,
    team_abbrev: str,
    player_stats: list,
    opponent_abbrev: str,
    opponent_stats: dict,
    is_home: bool,
    team_injuries: list = None,
    team_games: list = None
) -> str:
    """
    AI –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–≥—Ä—É.

    Args:
        player_name: –ò–º—è –∏–≥—Ä–æ–∫–∞
        player_position: –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞
        team_abbrev: –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã –∏–≥—Ä–æ–∫–∞
        player_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∏–≥—Ä
        opponent_abbrev: –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
        opponent_stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã
        is_home: –î–æ–º–∞—à–Ω—è—è –∏–≥—Ä–∞ –∏–ª–∏ –Ω–µ—Ç
        team_injuries: –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–≤–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã (OUT)
        team_games: –î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∏–≥—Ä–∞—Ö –∫–æ–º–∞–Ω–¥—ã (—Å–æ—Å—Ç–∞–≤—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)

    Returns:
        –¢–µ–∫—Å—Ç —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    """
    if not client:
        if not init_openai():
            return "AI –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API –∫–ª—é—á"

    # –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –º–∏–Ω—É—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏ "MM:SS" –≤ —á–∏—Å–ª–æ
    def parse_minutes(min_val):
        if min_val is None:
            return 0
        if isinstance(min_val, (int, float)):
            return float(min_val)
        if isinstance(min_val, str) and ':' in min_val:
            try:
                parts = min_val.split(':')
                return int(parts[0]) + int(parts[1]) / 60
            except:
                return 0
        try:
            return float(min_val)
        except:
            return 0

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–∞
    player_stats_text = ""
    if player_stats:
        avg_pts = sum(g.get('pts', 0) for g in player_stats) / len(player_stats)
        avg_reb = sum(g.get('reb', 0) for g in player_stats) / len(player_stats)
        avg_ast = sum(g.get('ast', 0) for g in player_stats) / len(player_stats)
        avg_min = sum(parse_minutes(g.get('min')) for g in player_stats) / len(player_stats)
        avg_stl = sum(g.get('stl', 0) for g in player_stats) / len(player_stats)
        avg_blk = sum(g.get('blk', 0) for g in player_stats) / len(player_stats)

        player_stats_text = f"""
–°–†–ï–î–ù–Ø–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ê 5 –ò–ì–†:
- –ú–∏–Ω—É—Ç—ã: {avg_min:.1f}
- –û—á–∫–∏: {avg_pts:.1f}
- –ü–æ–¥–±–æ—Ä—ã: {avg_reb:.1f}
- –ü–µ—Ä–µ–¥–∞—á–∏: {avg_ast:.1f}
- –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã: {avg_stl:.1f}
- –ë–ª–æ–∫–∏: {avg_blk:.1f}

–ü–û–°–õ–ï–î–ù–ò–ï 5 –ò–ì–† (–æ—Ç —Å–∞–º–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏–º - –∏–≥—Ä–∞ #1 —ç—Ç–æ –ü–û–°–õ–ï–î–ù–Ø–Ø —Å—ã–≥—Ä–∞–Ω–Ω–∞—è):"""
        for i, game in enumerate(player_stats, 1):
            matchup = game.get('matchup', 'N/A')
            game_date = game.get('date', '')
            pts = game.get('pts', 0)
            reb = game.get('reb', 0)
            ast = game.get('ast', 0)
            mins = game.get('min', 'N/A')
            is_starter = game.get('is_starter', True)

            # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã—Ö–æ–¥–∏–ª —Å–æ —Å–∫–∞–º–µ–π–∫–∏
            bench_marker = "" if is_starter else " [–°–û –°–ö–ê–ú–ï–ô–ö–ò]"
            player_stats_text += f"\n  {i}. [{game_date}] {matchup}: {pts}pts, {reb}reb, {ast}ast ({mins}–º–∏–Ω){bench_marker}"

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–ø–µ—Ä–Ω–∏–∫–µ
    opponent_text = ""
    if opponent_stats and 'games' in opponent_stats:
        opp_games = opponent_stats['games'][:5]

        # –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –æ—á–∫–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
        opp_pts_list = [g.get('team_pts', 0) for g in opp_games if g.get('team_pts')]
        avg_opp_pts = sum(opp_pts_list) / len(opp_pts_list) if opp_pts_list else 0

        opponent_text = f"\n\n–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–û–ü–ï–†–ù–ò–ö–ï ({opponent_abbrev}):"
        if avg_opp_pts > 0:
            opponent_text += f"\n–°—Ä–µ–¥–Ω–∏–µ –æ—á–∫–∏ –∑–∞ 5 –∏–≥—Ä: {avg_opp_pts:.1f}"
        opponent_text += f"\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
        for game in opp_games[:5]:
            pts = game.get('team_pts', 0)
            pts_str = f" - {pts}pts" if pts else ""
            opponent_text += f"\n  - {game.get('matchup', 'N/A')} ({game.get('result', 'N/A')}){pts_str}"

    venue = "–¥–æ–º–∞" if is_home else "–Ω–∞ –≤—ã–µ–∑–¥–µ"

    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
    news_data = get_relevant_news_for_analysis(
        player_name=player_name,
        team_abbrev=team_abbrev,
        opponent_abbrev=opponent_abbrev,
        days=3
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –±–ª–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    news_text = ""
    if news_data['has_relevant_news']:
        news_text = "\n\n–ê–ö–¢–£–ê–õ–¨–ù–´–ï –ù–û–í–û–°–¢–ò (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è):"

        if news_data['player_news']:
            news_text += "\n\n–ù–æ–≤–æ—Å—Ç–∏ –æ–± –∏–≥—Ä–æ–∫–µ:"
            for news in news_data['player_news'][:3]:
                title = news.get('title', '')
                content = news.get('content', '')  # –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏
                news_text += f"\n‚Ä¢ {title}"
                if content:
                    news_text += f"\n  {content}"

        if news_data['team_news']:
            news_text += "\n\n–ù–æ–≤–æ—Å—Ç–∏ –æ –∫–æ–º–∞–Ω–¥–µ:"
            for news in news_data['team_news'][:2]:
                title = news.get('title', '')
                content = news.get('content', '')  # –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏
                news_text += f"\n‚Ä¢ {title}"
                if content:
                    news_text += f"\n  {content}"
    else:
        news_text = "\n\n–ê–ö–¢–£–ê–õ–¨–ù–´–ï –ù–û–í–û–°–¢–ò: –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –æ–± —ç—Ç–æ–º –∏–≥—Ä–æ–∫–µ –∏–ª–∏ –∫–æ–º–∞–Ω–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–∞–≤–º–∞—Ö –∫–æ–º–∞–Ω–¥—ã –∏–∑ RotoWire
    injuries_text = ""
    if team_injuries:
        injuries_text = f"\n\n‚ö†Ô∏è –¢–†–ê–í–ú–ò–†–û–í–ê–ù–ù–´–ï/–í–´–ë–´–í–®–ò–ï –ò–ì–†–û–ö–ò –ö–û–ú–ê–ù–î–´ {team_abbrev} (–¥–∞–Ω–Ω—ã–µ RotoWire):"
        injuries_text += f"\n‚ùå –≠–¢–ò –ò–ì–†–û–ö–ò –ù–ï –ë–£–î–£–¢ –ò–ì–†–ê–¢–¨ –í –°–õ–ï–î–£–Æ–©–ï–ô –ò–ì–†–ï:"
        for injured_player in team_injuries:
            injuries_text += f"\n‚Ä¢ {injured_player} - OUT (–ù–ï –ò–ì–†–ê–ï–¢!)"
        injuries_text += f"\n\n‚Üí –≠—Ç–æ –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –æ —Å–æ—Å—Ç–∞–≤–µ –ù–ê –°–ï–ì–û–î–ù–Ø. –≠—Ç–∏ –∏–≥—Ä–æ–∫–∏ –û–¢–°–£–¢–°–¢–í–£–Æ–¢."
        injuries_text += f"\n‚Üí {player_name} –ø–æ–ª—É—á–∏—Ç —É–≤–µ–ª–∏—á–µ–Ω–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —ç—Ç–∏—Ö –∏–≥—Ä–æ–∫–æ–≤."
        injuries_text += f"\n‚Üí –ù–ï —É—á–∏—Ç—ã–≤–∞–π —Ç—Ä–∞–≤–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞!"
    else:
        injuries_text = f"\n\n–°–û–°–¢–ê–í –ö–û–ú–ê–ù–î–´ {team_abbrev}: –ü–æ–ª–Ω—ã–π —Å–æ—Å—Ç–∞–≤, –Ω–µ—Ç —Ç—Ä–∞–≤–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤."

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–∞–≤–∞—Ö –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∏–≥—Ä–∞—Ö
    lineups_context = ""

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–º—ë–Ω –ø–æ —Ñ–∞–º–∏–ª–∏–∏
    def get_last_name(name):
        parts = name.replace('.', '').split()
        return parts[-1].lower() if parts else ''

    player_last_name = get_last_name(player_name)

    if team_games:
        lineups_context = f"\n\n–°–û–°–¢–ê–í–´ –ö–û–ú–ê–ù–î–´ {team_abbrev} –í –ü–û–°–õ–ï–î–ù–ò–• 5 –ò–ì–†–ê–•:"
        for i, game in enumerate(team_games[:5], 1):
            matchup = game.get('matchup', 'N/A')
            result = game.get('result', 'N/A')
            starters = game.get('starters', [])
            all_players = game.get('all_players', starters)

            if starters:
                starters_names = [s.get('name', 'Unknown') for s in starters[:5]]
                lineups_context += f"\n  –ò–≥—Ä–∞ {i}. {matchup} ({result}):"
                lineups_context += f"\n    –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—è—Ç—ë—Ä–∫–∞: {', '.join(starters_names)}"

                # –ò—â–µ–º –∏–≥—Ä–æ–∫–∞ –≤–æ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–∞—Ö –º–∞—Ç—á–∞ (—Å—Ç–∞—Ä—Ç–µ—Ä—ã + —Å–∫–∞–º–µ–π–∫–∞)
                player_found = False
                for p in all_players:
                    if get_last_name(p.get('name', '')) == player_last_name:
                        is_starter = p.get('is_starter', True)
                        role = "" if is_starter else " [–°–û –°–ö–ê–ú–ï–ô–ö–ò]"
                        lineups_context += f"\n    ‚Üí {player_name}: {p.get('pts', 0)}pts, {p.get('reb', 0)}reb, {p.get('ast', 0)}ast{role}"
                        player_found = True
                        break

                # –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω - –æ–Ω –Ω–µ –∏–≥—Ä–∞–ª –≤ —ç—Ç–æ–π –∏–≥—Ä–µ
                if not player_found:
                    lineups_context += f"\n    ‚Üí {player_name}: –ù–ï –ò–ì–†–ê–õ (—Ç—Ä–∞–≤–º–∞/–æ—Ç–¥—ã—Ö)"

        lineups_context += f"\n\nüí° –ê–ù–ê–õ–ò–ó: –°–º–æ—Ç—Ä–∏ –∫–∞–∫ –º–µ–Ω—è–ª–∞—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ {player_name} –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–∞–≤–∞—Ö —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø—è—Ç—ë—Ä–∫–∏."

    # –ê–Ω–∞–ª–∏–∑ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    team_context = ""
    if player_stats:
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º W/L —Å–µ—Ä–∏—é –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–≥—Ä
        results = []
        for game in player_stats[:5]:
            matchup = game.get('matchup', '')
            if 'vs' in matchup or '@' in matchup:
                # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –æ—á–∫–∞–º
                results.append('?')  # –ù–µ –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

        team_context = f"\n\n–ö–û–ù–¢–ï–ö–°–¢ –ö–û–ú–ê–ù–î–´ {team_abbrev}:"
        team_context += f"\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∏–≥—Ä - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞"

    prompt = f"""–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ NBA –∞–Ω–∞–ª–∏—Ç–∏–∫–µ. –î–∞–π –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â—É—é –∏–≥—Ä—É.

–ò–ì–†–û–ö: {player_name} ({player_position})
–ö–û–ú–ê–ù–î–ê: {team_abbrev}
–°–û–ü–ï–†–ù–ò–ö: {opponent_abbrev} ({venue})
{player_stats_text}
{opponent_text}
{team_context}
{lineups_context}
{injuries_text}
{news_text}

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –ü–†–û –ü–û–†–Ø–î–û–ö –ò–ì–†:
- –ò–≥—Ä–∞ ‚Ññ1 = –°–ê–ú–ê–Ø –ü–û–°–õ–ï–î–ù–Ø–Ø –∏–≥—Ä–∞ (–ù–û–í–ï–ô–®–ê–Ø, —Å–∞–º–∞—è —Å–≤–µ–∂–∞—è –¥–∞—Ç–∞)
- –ò–≥—Ä–∞ ‚Ññ5 = –°–ê–ú–ê–Ø –°–¢–ê–†–ê–Ø –∏–≥—Ä–∞ (–±–æ–ª–µ–µ —Ä–∞–Ω–Ω—è—è –¥–∞—Ç–∞)
- –°–ø–∏—Å–æ–∫ –∏–¥–µ—Ç –æ—Ç –ù–û–í–´–• –∫ –°–¢–ê–†–´–ú –∏–≥—Ä–∞–º (1‚Üí2‚Üí3‚Üí4‚Üí5 = –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)

–ó–ê–î–ê–ß–ê:

1. **–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞ –û–ß–ö–û–í (5 –∏–≥—Ä)**:
   - –ó–∞–ø–∏—à–∏ –æ—á–∫–∏: –ò–≥—Ä–∞ ‚Ññ5 ‚Üí ‚Ññ4 ‚Üí ‚Ññ3 ‚Üí ‚Ññ2 ‚Üí ‚Ññ1
   - ‚ö†Ô∏è –ê–ù–û–ú–ê–õ–ò–ò: –ï—Å–ª–∏ –æ–¥–Ω–∞ –∏–≥—Ä–∞ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ >40% ‚Üí –ø–æ–º–µ—Ç—å –µ—ë [–ê–ù–û–ú–ê–õ–ò–Ø] –∏ –ù–ï –¥–µ–ª–∞–π –Ω–∞ –Ω–µ–π –≤—ã–≤–æ–¥ –æ —Ç—Ä–µ–Ω–¥–µ
   - –û–ø—Ä–µ–¥–µ–ª–∏ —Ç—Ä–µ–Ω–¥: –í–û–°–•–û–î–Ø–©–ò–ô / –ù–ò–°–•–û–î–Ø–©–ò–ô / –°–¢–ê–ë–ò–õ–¨–ù–´–ô (¬±3 –æ—á–∫–∞) / –í–û–õ–ê–¢–ò–õ–¨–ù–´–ô

2. **–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞ –ú–ò–ù–£–¢ (–∫–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä!)**:
   - –ó–∞–ø–∏—à–∏ –º–∏–Ω—É—Ç—ã: –ò–≥—Ä–∞ ‚Ññ5 ‚Üí ‚Ññ4 ‚Üí ‚Ññ3 ‚Üí ‚Ññ2 ‚Üí ‚Ññ1
   - –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Ç—Ä–µ–Ω–¥–∞:
     * –ï—Å–ª–∏ –æ—á–∫–∏ —Ä–∞—Å—Ç—É—Ç –ë–ï–ó —Ä–æ—Å—Ç–∞ –º–∏–Ω—É—Ç ‚Üí –¢–†–ï–ù–î –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò (–∏–≥—Ä–æ–∫ –≤ —Ö–æ—Ä–æ—à–µ–π —Ñ–æ—Ä–º–µ)
     * –ï—Å–ª–∏ –æ—á–∫–∏ —Ä–∞—Å—Ç—É—Ç –ó–ê –°–ß–Å–¢ –º–∏–Ω—É—Ç ‚Üí –¢–†–ï–ù–î –ù–ê–ì–†–£–ó–ö–ò (–±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ = –±–æ–ª—å—à–µ –æ—á–∫–æ–≤)
     * –ï—Å–ª–∏ –º–∏–Ω—É—Ç—ã —Ä–∞—Å—Ç—É—Ç, –Ω–æ –æ—á–∫–∏ –Ω–µ—Ç ‚Üí –°–ù–ò–ñ–ï–ù–ò–ï –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò
   - –£–∫–∞–∂–∏ —ç—Ç–æ –Ø–í–ù–û –≤ –∞–Ω–∞–ª–∏–∑–µ

3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –§–û–†–ú–´ –∏ –†–û–õ–ò**:
   - –§–û–†–ú–ê = —Ç—Ä–µ–Ω–¥ –æ—á–∫–æ–≤/—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∏–≥—Ä—ã
   - –†–û–õ–¨ = –∏–≥—Ä–æ–≤–æ–µ –≤—Ä–µ–º—è, –ø–æ–∑–∏—Ü–∏—è –≤ —Ä–æ—Ç–∞—Ü–∏–∏, –≤–ª–∏—è–Ω–∏–µ —Ç—Ä–∞–≤–º –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
   - ‚ö†Ô∏è –ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –æ—á–∫–æ–≤ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π, –ù–û —Ä–æ–ª—å —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å (OUT –ø–∞—Ä—Ç–Ω—ë—Ä—ã, —Ä–æ—Å—Ç –º–∏–Ω—É—Ç) ‚Üí –ü–†–ò–û–†–ò–¢–ï–¢ –†–û–õ–ò –Ω–∞–¥ —Ñ–æ—Ä–º–æ–π

4. **–ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –°–û–°–¢–ê–í–û–í –∫–æ–º–∞–Ω–¥—ã**:
   - –ü–æ—Å–º–æ—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª "–°–û–°–¢–ê–í–´ –ö–û–ú–ê–ù–î–´ –í –ü–û–°–õ–ï–î–ù–ò–• 5 –ò–ì–†–ê–•"
   - –° –∫–∞–∫–∏–º–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏ –∏–≥—Ä–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–ª –ª—É—á—à—É—é/—Ö—É–¥—à—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?
   - ‚ö†Ô∏è –¢–†–ê–í–ú–ò–†–û–í–ê–ù–ù–´–ï –∏–≥—Ä–æ–∫–∏ (—Ä–∞–∑–¥–µ–ª –≤—ã—à–µ) –ù–ï –ë–£–î–£–¢ –∏–≥—Ä–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è - –∏—Å–∫–ª—é—á–∏ –∏—Ö –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞

5. **–ê–Ω–∞–ª–∏–∑ —Å–∏–ª—ã —Å–æ–ø–µ—Ä–Ω–∏–∫–∞**:
   - –ü–æ—Å–º–æ—Ç—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (W/L, –æ—á–∫–∏ –¥–æ–ø—É—â–µ–Ω–Ω—ã–µ)
   - –£—á–∏—Ç—ã–≤–∞–π –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞ ({player_position}):
     * –ï—Å–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫ –¥–æ–ø—É—Å–∫–∞–µ—Ç –º–Ω–æ–≥–æ –æ—á–∫–æ–≤ guards ‚Üí —É–≤–µ–ª–∏—á—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è PG/SG
     * –ï—Å–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫ –¥–æ–ø—É—Å–∫–∞–µ—Ç –º–Ω–æ–≥–æ –æ—á–∫–æ–≤ forwards/centers ‚Üí —É–≤–µ–ª–∏—á—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è SF/PF/C
   - –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–∑–∏—Ü–∏—è–º ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–π —Ç—Ä–µ–Ω–¥ –æ—á–∫–æ–≤ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞

6. **–†–ê–°–ß–Å–¢ –ü–†–û–ì–ù–û–ó–ê** (—Å—Ç—Ä–æ–≥–∞—è —Ñ–æ—Ä–º—É–ª–∞):
   üî¢ –ë–ê–ó–ê = —Å—Ä–µ–¥–Ω–µ–µ –æ—á–∫–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∏–≥—Ä—ã (‚Ññ1, ‚Ññ2, ‚Ññ3)
   –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:
   - –°–∏–ª–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞: ¬±10-15% (—Å–ª–∞–±—ã–π/—Å–∏–ª—å–Ω—ã–π)
   - OUT –∏–≥—Ä–æ–∫–∏ –∫–æ–º–∞–Ω–¥—ã: +5-10% –µ—Å–ª–∏ –≤–µ–¥—ë—Ç –∫ —Ä–æ—Å—Ç—É –Ω–∞–≥—Ä—É–∑–∫–∏
   - –ù–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥: ‚àí5-10%
   - –í–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥: +5-10%
   - –¢—Ä–µ–Ω–¥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Ä–æ—Å—Ç –æ—á–∫–æ–≤ –±–µ–∑ —Ä–æ—Å—Ç–∞ –º–∏–Ω—É—Ç): +5%

   –î–∏–∞–ø–∞–∑–æ–Ω = –ë–ê–ó–ê √ó –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏, –æ–∫—Ä—É–≥–ª–∏—Ç—å –¥–æ —Ü–µ–ª—ã—Ö, —à–∏—Ä–∏–Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 4-6 –æ—á–∫–æ–≤

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ï–°–õ–ò —É–∫–∞–∑–∞–Ω–æ "–ü–æ–ª–Ω—ã–π —Å–æ—Å—Ç–∞–≤, –Ω–µ—Ç —Ç—Ä–∞–≤–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö" ‚Üí –ù–ï –ü–ò–®–ò –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ç—Ä–∞–≤–º–∞—Ö
- –ï–°–õ–ò —É–∫–∞–∑–∞–Ω —Å–ø–∏—Å–æ–∫ OUT –∏–≥—Ä–æ–∫–æ–≤ ‚Üí —É—á–∏—Ç—ã–≤–∞–π –∏—Ö –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤—ã–±—É–¥–µ—Ç"
- –ï–°–õ–ò –¥–ª—è –∏–≥—Ä–æ–∫–∞ —É–∫–∞–∑–∞–Ω–æ "–ù–ï –ò–ì–†–ê–õ" ‚Üí –ù–ï –≤–∫–ª—é—á–∞–π —ç—Ç—É –∏–≥—Ä—É –≤ —Ä–∞—Å—á—ë—Ç—ã

üìä –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

**1. –¢—Ä–µ–Ω–¥ –æ—á–∫–æ–≤**: ‚Ññ5‚Üí‚Ññ4‚Üí‚Ññ3‚Üí‚Ññ2‚Üí‚Ññ1: [—Ü–∏—Ñ—Ä—ã]
   ‚Üí –¢—Ä–µ–Ω–¥: [—Ç–∏–ø], –∞–Ω–æ–º–∞–ª–∏–∏: [–µ—Å—Ç—å/–Ω–µ—Ç]

**2. –¢—Ä–µ–Ω–¥ –º–∏–Ω—É—Ç**: ‚Ññ5‚Üí‚Ññ4‚Üí‚Ññ3‚Üí‚Ññ2‚Üí‚Ññ1: [—Ü–∏—Ñ—Ä—ã]
   ‚Üí –¢–∏–ø: [—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å/–Ω–∞–≥—Ä—É–∑–∫–∞/—Å–Ω–∏–∂–µ–Ω–∏–µ]

**3. –†–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ**: [primary scorer / secondary option / role player]
   ‚Üí –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑-–∑–∞ —Ç—Ä–∞–≤–º: [–¥–∞/–Ω–µ—Ç, –∫–∞–∫ –≤–ª–∏—è–µ—Ç]

**4. –°–æ–ø–µ—Ä–Ω–∏–∫**: [—Å–∏–ª—å–Ω—ã–π/—Å—Ä–µ–¥–Ω–∏–π/—Å–ª–∞–±—ã–π], –¥–æ–ø—É—Å–∫–∞–µ—Ç [X] –æ—á–∫–æ–≤ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é

**5. –ü–†–û–ì–ù–û–ó**:
   - –ë–∞–∑–∞ (—Å—Ä–µ–¥–Ω–µ–µ 3 –∏–≥—Ä): [X] –æ—á–∫–æ–≤
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏: [–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å]
   - **–û—á–∫–∏: X-Y** | –ü–æ–¥–±–æ—Ä—ã: A-B | –ü–µ—Ä–µ–¥–∞—á–∏: C-D
   - –†–æ–ª—å: [primary / secondary / role player]

–û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, –º–∞–∫—Å–∏–º—É–º 400 —Å–ª–æ–≤."""

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": """–¢—ã NBA –∞–Ω–∞–ª–∏—Ç–∏–∫ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑.
–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
1. –ú–ò–ù–£–¢–´ - –≥–ª–∞–≤–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –í—Å–µ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–≤—è–∑—å –º–∏–Ω—É—Ç –∏ –æ—á–∫–æ–≤.
2. –†–û–õ–¨ –≤–∞–∂–Ω–µ–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–º —Ç—Ä–µ–Ω–¥–µ. –ï—Å–ª–∏ —Ä–æ–ª—å —Ä–∞—Å—Ç—ë—Ç (OUT –ø–∞—Ä—Ç–Ω—ë—Ä—ã, –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç) - —ç—Ç–æ –ø–µ—Ä–µ–≤–µ—à–∏–≤–∞–µ—Ç –ø–ª–æ—Ö—É—é —Ñ–æ—Ä–º—É.
3. –ê–ù–û–ú–ê–õ–ò–ò (>40% –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ) –Ω–µ –¥–æ–ª–∂–Ω—ã –∏—Å–∫–∞–∂–∞—Ç—å —Ç—Ä–µ–Ω–¥ - –ø–æ–º–µ—á–∞–π –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ.
4. –ë–ê–ó–ê –ø—Ä–æ–≥–Ω–æ–∑–∞ = —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ 3 –∏–≥—Ä—ã —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏ (—Å–æ–ø–µ—Ä–Ω–∏–∫ ¬±10-15%, —Ç—Ä–∞–≤–º—ã +5-10%, —Ç—Ä–µ–Ω–¥ ¬±5-10%).
5. –î–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∑–∫–∏–º (4-6 –æ—á–∫–æ–≤), –Ω–µ —Ä–∞–∑–º—ã–≤–∞–π.
6. –ù–ï –¥–µ–ª–∞–π –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤—ã–±—ã—Ç–∏—è—Ö - —Ä–∞–±–æ—Ç–∞–π —Ç–æ–ª—å–∫–æ —Å —Ñ–∞–∫—Ç–∞–º–∏."""},
                {"role": "user", "content": prompt}
            ],
            max_tokens=900,
            temperature=0.6
        )

        ai_response = response.choices[0].message.content

        # –ü–∞—Ä—Å–∏–º –ø—Ä–æ–≥–Ω–æ–∑—ã AI –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –±—É–∫–º–µ–∫–µ—Ä—Å–∫–∏–º–∏ –ª–∏–Ω–∏—è–º–∏
        ai_predictions = parse_ai_prediction_ranges(ai_response)
        odds_comparison = compare_with_bookmaker_odds(player_name, ai_predictions)

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ –∞–Ω–∞–ª–∏–∑, –∏ –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        return (ai_response + odds_comparison, prompt)

    except Exception as e:
        return (f"–û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: {e}", "")


# –¢–µ—Å—Ç
if __name__ == "__main__":
    init_openai()

    # –¢–µ—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
    test_changes = {
        'new_players': ['Test Player'],
        'removed_players': ['LeBron James']
    }

    test_stats = {
        'games': [
            {
                'matchup': 'LAL vs GSW',
                'result': 'W',
                'starters': [
                    {'name': 'LeBron James', 'position': 'F', 'pts': 28, 'reb': 8, 'ast': 10},
                    {'name': 'Anthony Davis', 'position': 'C', 'pts': 32, 'reb': 14, 'ast': 3},
                ]
            }
        ]
    }

    result = analyze_lineup_changes('LAL', test_changes, test_stats)
    print(result)
